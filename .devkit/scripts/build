#!/usr/bin/env bash
set -e

# source in helper functions
source "$( dirname "${BASH_SOURCE[0]}" )/helpers/helpers.sh"

# Check if required tools are available
ensureMake
ensureForge
ensureDocker

log "Building contracts..."
(cd .devkit/contracts && forge clean && forge build -- --include ../../contracts/**/*.sol && cd -) >&2

# Build the contracts and dependencies
log "Building AVS performer..."
BUILD_CONTAINER=true ./.hourglass/scripts/build.sh >&2

# Get the build info
if [ -f ".hourglass/context/devnet.yaml" ]; then
  source .hourglass/context/devnet.yaml
else
  echo "Error: Build info not found"
  exit 1
fi

log "Built container: $IMAGE_NAME"
log "Image ID: $IMAGE_ID"

# Create JSON output with artifactId
RESULT=$(jq -n \
    --arg component "performer" \
    --arg artifactId "$IMAGE_ID" \
    '{
        artifacts: {
            component: $component,
            artifactId: $artifactId
        }
    }')

# Print the JSON to stdout
echo "$RESULT" | jq -c .

log "Build completed successfully." 